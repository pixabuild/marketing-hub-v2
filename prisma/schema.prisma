generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============ AUTH & USERS ============

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      String   @default("user") // admin, user
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  projects           Project[]
  appPermissions     UserAppPermission[]
  projectPermissions UserProjectPermission[]

  @@map("users")
}

model UserAppPermission {
  id        String   @id @default(cuid())
  userId    String
  appName   String   // 'affiliate_hq', 'financial_tracker'
  canAccess Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, appName])
  @@map("user_app_permissions")
}

model UserProjectPermission {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@map("user_project_permissions")
}

// ============ AFFILIATE HQ ============

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner       User                    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  platforms   Platform[]
  sales       DailySale[]
  traffic     DailyTraffic[]
  expenses    Expense[]
  goals       Goal[]
  permissions UserProjectPermission[]

  @@map("projects")
}

model Platform {
  id        String   @id @default(cuid())
  projectId String
  name      String
  type      String   // 'sales', 'traffic'
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name, type])
  @@map("platforms")
}

model DailySale {
  id         String   @id @default(cuid())
  projectId  String
  platform   String
  amount     Float
  salesCount Int      @default(1)
  saleDate   DateTime @db.Date
  externalId String?  // For sync with Financial Tracker
  createdAt  DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("daily_sales")
}

model DailyTraffic {
  id          String   @id @default(cuid())
  projectId   String
  source      String
  clicks      Int      @default(0)
  optins      Int      @default(0)
  cost        Float    @default(0)
  trafficDate DateTime @db.Date
  createdAt   DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("daily_traffic")
}

model Expense {
  id          String   @id @default(cuid())
  projectId   String
  category    String
  description String?
  amount      Float
  expenseType String   @default("one-time") // 'one-time', 'recurring'
  frequency   String?  // 'monthly', 'weekly', etc.
  expenseDate DateTime @db.Date
  externalId  String?  // For sync with Financial Tracker
  createdAt   DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("expenses")
}

model Goal {
  id            String   @id @default(cuid())
  projectId     String
  month         Int      // 1-12
  year          Int
  targetRevenue Float    @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, month, year])
  @@map("goals")
}

// ============ FINANCIAL TRACKER ============

model Category {
  id    String @id @default(cuid())
  name  String @unique
  type  String // 'income', 'expense'
  color String @default("#6c757d")

  transactions         Transaction[]
  recurringTransactions RecurringTransaction[]
  budgets              Budget[]

  @@map("categories")
}

model Transaction {
  id          String   @id @default(cuid())
  description String
  amount      Float
  type        String   // 'income', 'expense'
  categoryId  String?
  date        DateTime @db.Date
  externalId  String?  // For sync with AffiliateHQ
  source      String?  // 'affiliatehq', 'manual'
  createdAt   DateTime @default(now())

  category Category? @relation(fields: [categoryId], references: [id])

  @@map("transactions")
}

model RecurringTransaction {
  id          String   @id @default(cuid())
  description String
  amount      Float
  type        String   // 'income', 'expense'
  categoryId  String?
  frequency   String   // 'daily', 'weekly', 'biweekly', 'monthly', 'yearly'
  startDate   DateTime @db.Date
  nextDate    DateTime @db.Date
  isActive    Boolean  @default(true)
  externalId  String?  // For sync with AffiliateHQ
  source      String?  // 'affiliatehq', 'manual'
  createdAt   DateTime @default(now())

  category Category? @relation(fields: [categoryId], references: [id])

  @@map("recurring_transactions")
}

model Budget {
  id         String @id @default(cuid())
  categoryId String @unique
  amount     Float
  period     String @default("monthly")

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@map("budgets")
}
